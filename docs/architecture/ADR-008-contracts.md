# Contract Analysis: ADR-008 Platform Enhancement Suite

**Generated by**: apex-guardian
**Source ADR**: ADR-008 Platform Enhancement Suite
**Date**: 2026-01-17

---

## Summary

| Metric | Count |
|--------|-------|
| Integration Points | 8 |
| Contracts Documented | 14 |
| Critical Constraints | 18 |
| Potential Conflicts | 2 |
| Gaps Identified | 3 |

---

## Critical Contracts

### Contract 1: OrchestratorConfig Interface

**Location**: `src/orchestrator/synthesis-orchestrator.ts:26-40`
**Criticality**: MUST-MATCH

```typescript
export interface OrchestratorConfig {
  apiKey?: string;
  maxRetries?: number;
  timeoutMs?: number;
  traceEnabled?: boolean;
  traceOutputDir?: string;
  maxTokenBudget?: number;
  onProgress?: (stage: string, message: string) => void;
  enableEvidenceGatherer?: boolean;
  circuitBreaker?: {
    enabled?: boolean;
    failureThreshold?: number;
    resetTimeoutMs?: number;
  };
}
```

**Config Merge Pattern** (constructor lines 61-73):
```typescript
this.config = {
  // Defaults
  maxRetries: 2,
  timeoutMs: 120000,
  traceEnabled: false,
  traceOutputDir: './traces',
  enableEvidenceGatherer: false,
  ...config,  // User config spreads over defaults
  circuitBreaker: config.circuitBreaker ? {
    enabled: config.circuitBreaker.enabled ?? false,
    failureThreshold: config.circuitBreaker.failureThreshold ?? 5,
    resetTimeoutMs: config.circuitBreaker.resetTimeoutMs ?? 30000,
  } : undefined,
};
```

**CRITICAL**: New config fields MUST follow this spread pattern. Nested objects require explicit handling.

---

### Contract 2: BaseAgent Abstract Class

**Location**: `src/agents/base-agent.ts:25-230`
**Criticality**: MUST-EXTEND

```typescript
export abstract class BaseAgent<TInput, TOutput> {
  protected readonly client: Anthropic;
  protected readonly config: AgentConfig;
  protected tracker?: TokenTracker;
  protected traceCollector?: TraceCollector;

  constructor(client: Anthropic, config: AgentConfig);

  setTracker(tracker: TokenTracker): void;
  setTraceCollector(collector: TraceCollector): void;

  abstract execute(input: TInput, signal?: AbortSignal): Promise<TOutput>;
  protected abstract buildSystemPrompt(): string;
  protected abstract buildUserPrompt(input: TInput): string;
  protected abstract parseResponse(response: string): TOutput;

  protected async callLLM(systemPrompt: string, userPrompt: string, options?: {...}): Promise<string>;
  protected extractJSON(response: string): string;
  protected async processWithConcurrency<T, R>(items: T[], maxConcurrent: number, processor: (item: T) => Promise<R>): Promise<R[]>;
}
```

**AgentConfig Interface**:
```typescript
export interface AgentConfig {
  name: string;
  model: 'claude-opus-4-20250514' | 'claude-sonnet-4-20250514';
  maxTokens: number;
  temperature?: number;  // Default: 0.7
}
```

**CRITICAL**:
- `execute()` MUST accept optional `signal?: AbortSignal` parameter
- `execute()` MUST pass `signal` to `callLLM()` via options object
- `parseResponse()` MUST use `this.extractJSON()` for JSON extraction

---

### Contract 3: TokenTracker Interface

**Location**: `src/agents/base-agent.ts:17-19`

```typescript
export interface TokenTracker {
  recordUsage(agent: string, model: string, usage: TokenUsage): void;
}
```

**TokenUsage Schema** (`src/types/tokens.ts`):
```typescript
export type TokenUsage = {
  inputTokens: number;
  outputTokens: number;
};
```

---

### Contract 4: TraceCollector Interface

**Location**: `src/agents/base-agent.ts:21-23`

```typescript
export interface TraceCollector {
  recordTrace(entry: TraceEntry): void;
}
```

**TraceEntry Schema** (`src/types/trace.ts`):
```typescript
export type TraceEntry = {
  stage: string;
  agent: string;
  model: string;
  timestamp: string;  // ISO datetime
  input: { system: string; user: string };
  output: { raw: string; parsed?: unknown };
  usage: TokenUsage;
  durationMs: number;
};
```

---

### Contract 5: CircuitBreaker Class

**Location**: `src/resilience/circuit-breaker.ts:21-114`

```typescript
export type CircuitBreakerState = 'CLOSED' | 'OPEN' | 'HALF_OPEN';

export interface CircuitBreakerConfig {
  failureThreshold: number;
  resetTimeoutMs: number;
  name?: string;
}

export class CircuitBreaker {
  constructor(config: CircuitBreakerConfig);
  canExecute(): boolean;
  recordSuccess(): void;
  recordFailure(): void;
  getState(): CircuitBreakerState;
  reset(): void;
}
```

---

### Contract 6: Error Types

**Location**: `src/types/errors.ts`

```typescript
export class TimeoutError extends Error {
  readonly operationName: string;
  readonly timeoutMs: number;
  constructor(operationName: string, timeoutMs: number);
}

export class CircuitOpenError extends Error {
  readonly circuitName: string;
  constructor(circuitName: string);
}
```

**Error Pattern**: All custom errors extend `Error`, set `this.name`, include contextual readonly properties.

---

### Contract 7: Hypothesis Schemas

**Location**: `src/types/hypothesis.ts`

```typescript
// Extension chain:
HypothesisSchema (base)
  → ScoredHypothesisSchema.extend({scores, verdict, challengeNotes})
    → RankedHypothesisSchema.extend({rank})
      → EvidencedHypothesisSchema.extend({evidence}) // NEW for Phase 3
```

---

### Contract 8: Citation Schema

**Location**: `src/types/domains.ts:427-450`

```typescript
export type Citation = {
  id: string;
  type: 'paper' | 'preprint' | 'book' | 'website' | 'llm-knowledge';
  title: string;
  authors?: string[];
  year?: number;
  venue?: string;
  url?: string;
  doi?: string;
  relevance: string;
  verified: boolean;
};
```

---

### Contract 9: DomainTag Enum

**Location**: `src/types/domains.ts:11-23`

```typescript
export type DomainTag =
  | 'computational-biology'
  | 'materials-science'
  | 'ml-ai'
  | 'economics-finance'
  | 'social-systems'
  | 'physics-engineering'
  | 'climate-environment'
  | 'healthcare-medicine'
  | 'cognitive-science'
  | 'information-systems'
  | 'other';
```

**CRITICAL**: Use `normalizeDomain()` from `src/types/index.js` to handle LLM output variations.

---

## Stage Execution Pattern

**Location**: `src/orchestrator/synthesis-orchestrator.ts:170-204`

All stage methods MUST follow this pattern:
```typescript
private async runStageName(context: PipelineContext): Promise<void> {
  const startTime = Date.now();
  context.log('Stage N: Stage Name');
  this.reportProgress('stage-name', 'Description...');

  try {
    const result = await this.withRetry((signal) =>
      this.agent.execute(input, signal)
    );

    context.setResult(result);
    context.addStage({
      stage: 'stage-name',
      status: 'success',
      durationMs: Date.now() - startTime,
      message: `Summary...`,
    });
  } catch (error) {
    context.addStage({
      stage: 'stage-name',
      status: 'error',
      durationMs: Date.now() - startTime,
      message: String(error),
    });
    throw error;
  }
}
```

---

## Potential Conflicts

### Conflict 1: Console.log vs Winston
**New code**: Winston logging
**Existing**: `console.log()` throughout
**Resolution**: Create Winston logger that preserves trace ID correlation

### Conflict 2: Per-Agent vs Shared Circuit Breaker
**New code**: Per-agent circuit breakers
**Existing**: Single shared breaker
**Resolution**: Add `circuitBreaker.perAgent?: boolean` config option

---

## Gaps to Address

1. **Schema Versioning Interface**: Add `schemaVersion` field to TraceMetadataSchema
2. **Deduplication Config**: Add `deduplication` section to OrchestratorConfig
3. **Evidence Gatherer Context**: Add `setEvidencedHypotheses()` to PipelineContext

---

## Task Decomposer Guidance

### For Winston Logging (Phase 1):
- MUST implement TokenTracker and TraceCollector interfaces
- Preserve trace ID correlation format: `[{traceId.slice(0,8)}] message`

### For Per-Agent Circuit Breakers (Phase 1):
- Extend existing CircuitBreaker class, NOT replace
- Create `Map<agentName, CircuitBreaker>` for per-agent isolation

### For LLM Domain Classification (Phase 2):
- MUST return valid DomainTag from DomainTagSchema
- Call `normalizeDomain(llmOutput, fallbackDomain)` on LLM response

### For Evidence Gatherer (Phase 3):
- MUST extend BaseAgent<EvidenceRequest, EvidenceResult>
- MUST accept AbortSignal in execute()
- Default all citations to `verified: false`
